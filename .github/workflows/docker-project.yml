name: Docker project 
on: workflow_dispatch
jobs: 
  build:
      runs-on: ubuntu-latest
      steps:
        - name: Clone git project 
          run: git clone https://github.com/taigaio/taiga-docker.git
          
        - name: Run scripts
          run: |
              cd taiga-docker
              git checkout stable
              sed -i '/&default-back-environment/,/^$/!b;/^$/i \  PUBLIC_REGISTER_ENABLED: "True"' docker-compose.yml
              sed -i '/taiga-front:/,/TAIGA_SUBPATH:/!b;/TAIGA_SUBPATH:/a \      PUBLIC_REGISTER_ENABLED: "true"' docker-compose.yml
              ./launch-all.sh
              timeout 60s bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' http://localhost:9000/api/v1/)" != "200" ]]; do sleep 2; done' || false
              
        - name: Create super user
          run: |
              ./taiga-manage.sh shell <<EOF
              from django.contrib.auth import get_user_model
              User = get_user_model()
              User.objects.create_superuser("admin", "admin@example.com", "admin")
              EOF
        - name: Curl
          run: |
            curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"type": "normal", "username": "admin", "password": "admin"}' \
              http://localhost:9000/api/v1/auth
          
